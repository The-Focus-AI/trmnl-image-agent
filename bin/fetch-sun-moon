#!/bin/bash
# Fetch sunrise, sunset, and moon phase for Cornwall, CT
# Uses calculation-based approach for reliability
# Outputs JSON to stdout

set -e

# Cornwall, CT coordinates
LAT="41.8456"
LON="-73.3284"

# Get current date
TODAY=$(date +%Y-%m-%d)
DAY_OF_YEAR=$(date +%j)
YEAR=$(date +%Y)

# Calculate approximate sunrise/sunset for Cornwall, CT year-round
# Uses simplified solar equation via python for trig functions
# Use pipe-delimited output to avoid word-splitting on spaces in "6:39 AM"
SUN_TIMES=$(python3 -c "
import math
lat = 41.8456
doy = int('$(date +%j)'.lstrip('0') or '1')
# Solar declination
decl = -23.45 * math.cos(math.radians(360/365 * (doy + 10)))
decl_rad = math.radians(decl)
lat_rad = math.radians(lat)
# Hour angle
ha = math.degrees(math.acos(-math.tan(lat_rad) * math.tan(decl_rad)))
# Solar noon in hours UTC (Cornwall ~73.3W => ~4.89h offset)
solar_noon = 12.0 + 73.3284 / 15.0
rise_utc = solar_noon - ha / 15.0
set_utc = solar_noon + ha / 15.0
# Convert to Eastern (UTC-5)
rise_et = rise_utc - 5.0
set_et = set_utc - 5.0
def fmt(h):
    if h < 0: h += 24
    period = 'AM' if h < 12 else 'PM'
    h12 = int(h) % 12 or 12
    m = int((h - int(h)) * 60)
    return f'{h12}:{m:02d} {period}'
print(f'{fmt(rise_et)}|{fmt(set_et)}')
")
SUNRISE="${SUN_TIMES%%|*}"
SUNSET="${SUN_TIMES##*|}"

# Calculate moon phase
# New moon was on Jan 29, 2025. Lunar cycle is 29.53 days.
# Reference: Jan 29, 2025 = new moon (day 0)
DAYS_SINCE_REF=$(( ($(date +%s) - $(date -j -f "%Y-%m-%d" "2025-01-29" +%s 2>/dev/null || date -d "2025-01-29" +%s)) / 86400 ))
LUNAR_CYCLE=29.53
PHASE_DAY=$(echo "$DAYS_SINCE_REF % 29.53" | bc 2>/dev/null || echo "$((DAYS_SINCE_REF % 30))")
# bc may return ".11" (no leading zero) - ensure we get an integer
PHASE_DAY_INT=$(printf "%.0f" "$PHASE_DAY" 2>/dev/null || echo "0")

# Determine moon phase name
if [ "$PHASE_DAY_INT" -lt 2 ]; then
  MOON_PHASE="new moon"
elif [ "$PHASE_DAY_INT" -lt 7 ]; then
  MOON_PHASE="waxing crescent"
elif [ "$PHASE_DAY_INT" -lt 9 ]; then
  MOON_PHASE="first quarter"
elif [ "$PHASE_DAY_INT" -lt 14 ]; then
  MOON_PHASE="waxing gibbous"
elif [ "$PHASE_DAY_INT" -lt 16 ]; then
  MOON_PHASE="full moon"
elif [ "$PHASE_DAY_INT" -lt 21 ]; then
  MOON_PHASE="waning gibbous"
elif [ "$PHASE_DAY_INT" -lt 23 ]; then
  MOON_PHASE="last quarter"
else
  MOON_PHASE="waning crescent"
fi

cat << EOF
{
  "fetched_at": "$(date -Iseconds)",
  "date": "${TODAY}",
  "location": "Cornwall, CT",
  "sunrise": "${SUNRISE}",
  "sunset": "${SUNSET}",
  "moon_phase": "${MOON_PHASE}",
  "moon_phase_day": ${PHASE_DAY_INT:-0}
}
EOF
